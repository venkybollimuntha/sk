# # # l1_not_in_l0 = ['003372875111', '007707791333', '009348927679', '019347635701', '021000367750', '021365338423', '022169245411', '026427244252', '028533194311', '034322051670', '035483035615', '041479117925', '051994682883', '056630023496', '056863834668', '067350284291', '069580900393', '075458757601', '084970654249', '085773352584', '092327206231', '094299405254', '094827805839', '095139704753', '097475337748', '097795456520', '098000758385', '101796278814', '104590855980', '110613030397', '113176856871', '121964457821', '122578856689', '123155530402', '125237375797', '126523394397', '126667425912', '128731681412', '130149840165', '131610679465', '134679210625', '135285569980', '137885247948', '143247161605', '143711193266', '144475990439', '149089727609', '149148767097', '153772258784', '160327063738', '165159114599', '166101436673', '167187402137', '167226961519', '168441963426', '169515270762', '170394039252', '173538766175', '174295623751', '174961374134', '176996053919', '181613734321', '185671863613', '187879053795', '190367388287', '190642798438', '192614291797', '194695465174', '194928253959', '195566443221', '198271522709', '199099526724', '199360944383', '203158740621', '204053091687', '204630464347', '209441755774', '210632014336', '211508935776', '211695053472', '212271771810', '220730334052', '222001666987', '222020306244', '222624872065', '225805886800', '229679863806', '232448574943', '234772266870', '236248596881', '241396937347', '242199234071', '242753836132', '246704155817', '248014647110', '249285578332', '251641150286', '252077205715', '253933647263', '255798633318', '263648093447', '264619089984', '264629864623', '266010434788', '267316576554', '272851264686', '275309946303', '277615250575', '277922364851', '282053871296', '286814544202', '291704570552', '292767457610', '292995354700', '294658461048', '295998058776', '296351982715', '297947569761', '301605300944', '303364506186', '305890512688', '307036072367', '315724403350', '316021091064', '318783272265', '319338734333', '321307503701', '322601554261', '323232363111', '323817093338', '326755649394', '327639925109', '328061036419', '329106378841', '336512527178', '342163036816', '343248351138', '344653063612', '347229344523', '349091595040', '351943365646', '354173411065', '354366284558', '358132790115', '358508000257', '359695216436', '362629117613', '363220349094', '365379373575', '365522681417', '365664458300', '365753072011', '373510380303', '376460358145', '376839262288', '380737479390', '380769935574', '385570000518', '388634006099', '390217200304', '392479946920', '393624352404', '395562096909', '397709778342', '399553586947', '407294690266', '413582460477', '415381292284', '420191660637', '424467068503', '427183723235', '431903633673', '435453563095', '437813383155', '441189720969', '442073219544', '442716992213', '445421740248', '446521373869', '447033644314', '447579392870', '452055674543', '457326670944', '468323486041', '471501708651', '473012084470', '475182315323', '477730144921', '478518164695', '478577616413', '478925142388', '479017279804', '479521414473', '481315189088', '482815256356', '485042675174', '490455086580', '496900188711', '497647849039', '497934097495', '500008131718', '501765712544', '504857848042', '509386356242', '511051334879', '511507869156', '512889038796', '520846418629', '525174722646', '525729546547', '527319450606', '536017423151', '539278275488', '540791212970', '540957243980', '541144414411', '541833898623', '542562960121', '545298271467', '547250268408', '547500692192', '550446022751', '550882646259', '551587375342', '551799593302', '552668850488', '552923642514', '555869646217', '557955772651', '561971607098', '567514599659', '569594090084', '572023949181', '577914934418', '579155750082', '583989446449', '588949991295', '593190477397', '593391513284', '599187033811', '599569244858', '600142321150', '600424674755', '600555062417', '601290880738', '602706386284', '604033226315', '604707100243', '608583646195', '611316385221', '616864236654', '619171252003', '619768731561', '628625382433', '630697057306', '635675837571', '636712211284', '638365212721', '642264126148', '645182689106', '646023701073', '650149263190', '651491549966', '652254402111', '652943102365', '654872607431', '655572130710', '667485214512', '667662266003', '674058067202', '674583080303', '682033880221', '690966616852', '692721260310', '693542608313', '697872195742', '698031681033', '698776863250', '700210323933', '701275957923', '701862677052', '703674870110', '703906235327', '705043942076', '705182684277', '705566307488', '705967963585', '707012202561', '708437838039', '717502159111', '718832137337', '719283693773', '720366697201', '720724015417', '721284546788', '721369432361', '721523660704', '723788595012', '724343007644', '726327367093', '727456174053', '728061972801', '728483363736', '730275874014', '731923714466', '733804268833', '734998425718', '736713133364', '737141037132', '739672651720', '740053198814', '740123709034', '741274041958', '745686942713', '746080954153', '749115363610', '750227276023', '750808625910', '751142013127', '753455713898', '753904791510', '755312818847', '756414919982', '758763400630', '762478760418', '763186303361', '767857357979', '768955793546', '769986034361', '770381447961', '773334544016', '775762748442', '776173975841', '780113007310', '785183849335', '785817577328', '786289358306', '788093788772', '788247499336', '790874520702', '792374790622', '795085004402', '796591184867', '798831350617', '800436161211', '803115734520', '803466671685', '803611162529', '807269076110', '808028441788', '812263245315', '814255944148', '816813650017', '828170655941', '829296092291', '831795865367', '839326706163', '843058968294', '843385628534', '843968153990', '846230196886', '847293893566', '855484158442', '855777208844', '856019220660', '856464429809', '858312341223', '858633904165', '859828415022', '868978391936', '872335144391', '872425586473', '879472252061', '882194302238', '885718323853', '885924542129', '886015701061', '893441358747', '895114609877', '900397174018', '901519578274', '903662551929', '906924434830', '911444749492', '911593296289', '914550290266', '915366716420', '915431102062', '916086415886', '916378955819', '918824989007', '921134338319', '921400275636', '929888664800', '934472131788', '935855703025', '942547771823', '943200330016', '943942458547', '947692952239', '948572612712', '949050008497', '953636518551', '956058981677', '956885745546', '960737463278', '962383023396', '962612127814', '962639478670', '963363688713', '963365592956', '970224627637', '975817023078', '978671209663', '981805318608', '982693706514', '983350415204', '983728535136', '985676819172', '986012759135', '987825197801', '988601501448', '993130990278', '993836073940', '994090975690', '003788644068', '004420648591', '022791440266', '033065397244', '034526171824', '034536176640', '036093542835', '040046960803', '043330710293', '047209783566', '047749980333', '052819490290', '053082227562', '053444045268', '056412096258', '062387122580', '065911132104', '067447795879', '073208257581', '073546915641', '078769231505', '084367452833', '086102618356', '086301938642', '093916721094', '102145276445', '102302903403', '102771375180', '116222102902', '120311362244', '124841701563', '127513335444', '128264176259', '128346779966', '131750173436', '133277734215', '142803759194', '143312840871', '148392725318', '154843675742', '157812473613', '161775556864', '166449560162', '169912408263', '173373426076', '174145408811', '174278580167', '175472836528', '176443733777', '176539146345', '181864525870', '188831284171', '195616859884', '202120059134', '204385000248', '204485639007', '206793667976', '232144315514', '232930013947', '247012361096', '254313626187', '255311346772', '276287038763', '283711851771', '305213819503', '305317527087', '307670020531', '308350474287', '311642618236', '320383732799', '321026552774', '329503450035', '333186577928', '334144298543', '334352873287', '340021236041', '340179473373', '345595150906', '355214048684', '371132510028', '371209647698', '373337982383', '381173206319', '388830625952', '389222194029', '420924285556', '424023865363', '425844425297', '426187456338', '426843455707', '433860551753', '440708338928', '443482151530', '446543602545', '449696838726', '456716556996', '473250842200', '481383093164', '482709997193', '484797066964', '486687906253', '488791035777', '497228614851', '510920009915', '516386627390', '521756226937', '523122162952', '523471060002', '523890020650', '524666392392', '525684156106', '540404953683', '540656245819', '542906167192', '543492705153', '543691652517', '544206404384', '545560008065', '552923642514', '553526484992', '553697376517', '556116077166', '556759822564', '558067152068', '560596504822', '563511753176', '565010824322', '570051990040', '580375422572', '580411221872', '585514194047', '589202808364', '592578543696', '595716108428', '597442721103', '601947996617', '607851404322', '611480974551', '613809103576', '614751792119', '618222675128', '621577900889', '622913598307', '624603845543', '625466519857', '630033476802', '632621214384', '635786325450', '643987766248', '645286070021', '645683819147', '648080342736', '651409190172', '659069636583', '662929856130', '670111638441', '670999639077', '682655211644', '683173620724', '683340563767', '688120237422', '702011104433', '702064102213', '706151101526', '710230637982', '717090925392', '717151169743', '723606622699', '728610086968', '744048656618', '746203666711', '749257892087', '750378041276', '751720771238', '763232339158', '764230540928', '769553063621', '769985493362', '773559476152', '775302474189', '777973684917', '779420033654', '791422305768', '791959462774', '792645976151', '796155319658', '796937856387', '799867849121', '805039658749', '805522167547', '806037382723', '810613220646', '816348406744', '827001787104', '829955684988', '831587722162', '841208569552', '850791908078', '851787832323', '861990178126', '873697805464', '875635120922', '878153322966', '898483634510', '900406205346', '904005903356', '915503999640', '924473885417', '928604188985', '932346075053', '942265044478', '943971716662', '949955964069', '957627549507', '960841581879', '965416789171', '967227327126', '971424449433', '973896107202', '982104967400', '982190825179', '989504077972', '993001063892', '997715449024', '998663967865']
# # # out = []
# # # for x in l1_not_in_l0:
# # #     out.append(int(x))

# # # print(out)

# # # print(len(l1_not_in_l0))
# # # l0_not_in_l1 = ['010373844257', '013724545051', '022663055756', '025502614753', '027804237073', '035657162383', '036611309112', '047681963590', '050111803238', '057239939437', '062637643455', '062790058996', '066569650784', '077365842699', '081577392665', '084707884338', '089402802109', '094552460557', '099189045841', '101470261478', '114724603768', '114858314951', '116452690986', '116909240956', '119373311443', '119529477927', '120379190565', '121652837644', '122616578453', '122674790828', '123686375669', '127095091672', '131372407359', '139914741522', '141578125655', '151577017449', '152692632441', '153125681988', '158830002625', '160133382852', '166223901165', '172296105687', '178798771574', '191346140709', '203622632891', '217463887104', '224286928353', '236244464571', '240210116683', '247015892866', '252702702909', '253026504241', '253034832134', '253123616265', '257173906640', '294454434120', '300825029455', '301923971814', '304084972275', '304576424523', '304844249827', '305132896877', '314297002272', '316658889291', '322885182098', '328741113609', '330248483315', '334873317999', '336385788515', '341813341134', '342451229934', '345693200111', '349082719353', '350045283196', '357362362136', '359797200114', '364980597341', '365322098407', '372886211720', '375127515215', '376072711816', '385203934575', '389956108244', '403878382125', '405743288520', '407512270482', '414344255365', '415898374611', '418978190712', '427590496635', '441010300410', '445452159007', '446327656647', '448096295602', '448437791421', '453914492133', '456893043309', '458451669361', '474303134594', '476144844511', '477503752563', '479058449553', '479201903159', '483555791534', '485171739360', '487075835117', '488730987161', '512296068723', '512436193157', '519581326750', '523544263548', '524725421296', '526002620700', '535108280501', '539864271063', '554385559122', '565115787062', '572336037108', '588159678948', '588259907349', '590032489899', '590356385337', '593991997540', '598559248149', '600636239655', '610215273417', '610387278800', '615839074094', '615986332594', '619245725626', '621401273440', '625402342851', '629644073792', '630020482417', '632338919882', '639729112487', '642675037886', '652394602738', '654434512251', '655641897893', '656256919338', '668314542521', '695614360589', '695927472067', '707216201787', '707230609171', '707967128746', '708349364971', '713962568261', '726062910967', '733734154655', '747334583968', '747424048911', '748031854237', '749876805881', '752327656508', '754775705348', '756991211222', '771615742381', '773484745606', '790481191661', '806542883926', '809221857512', '812519411640', '817888888251', '821085792879', '833267802779', '837703541926', '843504708241', '867752219685', '869064364163', '870031545560', '871102085030', '871472515762', '875895939522', '880642969338', '883606944081', '884481293184', '886659585567', '887126066436', '894369697281', '912751028336', '915416998552', '921084973823', '927358699734', '929862073750', '937511639188', '937804906182', '940473554828', '943160461060', '954539648113', '954983321707', '957306922246', '960162230649', '961527323227', '964462942334', '967480132046', '987142698092', '994324121608', '994837143917']

# # # import requests

# # # def load_account_metadata(account_id):
# # #     """Get account metadata from Nova API"""

# # #     nova_report_url = f"http://nova.dcs.deloitte.com/api/report/account?account_id={account_id}"
# # #     nova_api_key = "b4fe4ccd-99c2-a129-f0a8-c555cb4724d2"

# # #     headers = {
# # #         'nova-x-api-key': nova_api_key,
# # #         'User-Agent': "PostmanRuntime/7.17.1",
# # #         'Accept': "*/*",
# # #         'Cache-Control': "no-cache",
# # #         'Postman-Token': "c9eacdbd-cdad-43e6-adea-931232fcb8ad,01db3bc8-1059-4aa7-9103-e3ab1f8a889b",
# # #         'Accept-Encoding': "gzip, deflate",
# # #         'Referer': "http://nova.dcs.deloitte.com/api/report/accounts",
# # #         'Connection': "keep-alive",
# # #         'cache-control': "no-cache",
# # #         "Accept-Version": "nova.2022-05-03",
# # #     }

    
# # #     response = requests.get(f"{nova_report_url}", headers=headers)
    
# # #     if response.status_code == 200:
# # #         novaData = response.json()
# # #         # print(f'Processed Nova data: {novaData}')
# # #         return novaData
# # #     elif response.status_code == 404:
# # #         # print(f"Failed to get account details: {response.status_code}")
# # #         return novaData

# # # l0_not_in_l1_dict = {}
# # # c = 0
# # # l0_not_in_l1 = ["094552460557"]
# # # for account in l0_not_in_l1:
# # #     try:
# # #         print(f"current iteration {c} of total {len(l0_not_in_l1)}")
# # #         nova_data = load_account_metadata(account)
# # #         if nova_data['account']['cbilling']['account_status'] == 'ACTIVE':
# # #             l0_not_in_l1_dict[account] = nova_data['account']["admin_email_address"]
# # #         c+=1
# # #     except Exception as e:
# # #         print("Exception for the account::", account,e)

# # # print(l0_not_in_l1_dict)

# # import boto3
# # import time
# # from datetime import date, datetime
# # import json
# # from datetime import datetime
# # import sys
# # from botocore.exceptions import ClientError
# # import logging
# # import os
# # import sys
# # import requests

# # total_accounts = [ '012046266255', '016101336017', '018472551420', '021191302697', '024517926231', '024838550089', '025625448852', '025648210413', '028002051339', '030263312215', '031043502080', '031573843522', '035784263114', '038144103111', '038270351176', '039233901334', '039929384510', '041081560071', '050877488444', '053392642336', '055182143107', '055266516288', '059272759707', '060465202534', '067555441682', '067804797237', '068183022879', '068315429392', '070717231209', '072038240142', '084383639626', '087127721683', '088258796410', '092606503522', '104624496682', '107393473960', '109577287868', '119753528152', '122600361133', '130203272373', '135381627630', '139100456334', '144544136090', '155305736938', '156327752252', '158347257464', '158684596895', '161395754509', '162310846309', '162435009311', '163564840054', '163918101077', '166556434326', '168131472534', '170178091998', '170302206609', '172383415443', '173316567229', '173479391558', '174188575348', '175742142056', '181395753476', '185075825010', '186574298919', '194751376404', '198162557634', '201547482655', '201944482039', '204193633058', '205394135495', '208073657936', '208626548723', '211070001969', '212149607166', '212773838067', '217413253555', '218167183912', '220288712633', '222023357012', '222762603060', '228052005984', '232698387549', '233632481017', '234019974018', '234848667271', '239459044292', '240344030626', '241671150056', '241693290537', '241696072805', '251058218532', '254471163821', '257915333181', '258860010574', '262259241401', '266527211573', '268527685757', '277946231630', '281981188021', '282181226940', '282623329273', '284383242428', '290092688251', '294297099413', '298370672248', '309245159336', '312249472578', '318724812262', '318902570495', '320947721229', '327370950832', '328754255717', '332205887294', '336222303362', '336827305173', '340860049954', '345414987291', '354362986338', '363191287345', '366986788235', '366987310429', '367544918569', '371132510028', '372988589375', '373124920883', '374125395891', '376587057974', '385159429807', '389613005727', '392047261520', '395672011172', '398358669351', '403327078303', '404335588036', '410871088857', '414878987508', '415076259107', '415096990548', '416380726237', '417276993801', '422660281210', '422716773809', '426325367657', '426909158075', '431768475246', '433112528293', '434820176994', '436950664991', '441977708642', '442279558925', '445544608757', '447099417955', '447333052098', '454243075918', '454878478860', '455295949501', '456012650670', '457633433589', '458712402796', '459741916297', '460579496107', '463748631505', '470892628663', '471764684541', '475312077285', '475679390152', '475704409833', '480207372766', '486318442788', '487825727312', '488502120284', '490723148876', '492182230036', '492809362056', '494419598111', '498306521888', '504206122956', '511898103173', '512593562953', '514641961978', '522610480753', '526851179788', '529102001334', '531885649505', '534939542028', '536825901754', '537669063398', '538115423334', '541061827746', '542083475947', '542734845675', '544536937525', '545240029200', '545994597414', '547578050363', '551757942034', '564649271459', '568396353920', '571208668853', '572027877266', '573859772831', '581130070053', '581328788659', '583106373569', '586329412044', '588607312191', '589327882798', '593780602920', '594796041417', '597373045724', '598578472115', '598783347326', '608959785178', '609608201737', '615475426900', '615864598532', '617366402669', '618143286284', '621848218806', '622372203913', '623899618944', '623940634196', '624925071076', '626553292796', '628943449194', '632954654882', '637376217363', '637928158385', '639369182738', '640259690623', '644969574939', '646717608788', '650644976608', '657107451157', '659576002760', '664785693086', '670404736065', '678835796394', '680069428997', '681044841647', '681356837841', '683133891344', '684757896148', '685107354181', '686387901187', '696141481732', '698551361437', '699789982634', '701438804970', '701970095679', '703829513590', '707763339947', '710465056204', '721294810136', '721462236188', '726012408397', '727600915853', '729269827574', '731082648661', '735624102611', '736819047443', '738852525135', '740123642997', '740153750092', '741012202819', '741732532483', '743862158735', '746177754969', '747229060202', '750802954404', '753874989666', '755090050495', '757031139434', '758360774458', '762594668164', '764177646170', '776522867075', '778558837889', '779558345599', '781297070656', '782998046294', '792126690708', '792958435369', '797231615719', '798052893433', '798485367562', '804269864808', '812790839692', '813055922763', '813558814731', '814582850999', '819300110664', '819716157095', '821372114949', '826429160863', '828290435030', '831323883328', '835173813168', '836686594237', '836809512233', '840214933274', '840365407675', '841168632450', '844577878525', '844677627151', '850702558675', '854481054617', '857578946837', '867168973137', '867327676348', '872800060950', '877574383758', '879286378355', '884435246449', '886409264347', '896914459532', '898090075122', '901022633716', '903186577214', '904168909248', '905676609443', '912103569023', '914628935504', '918013418617', '918701091807', '919235719473', '920037858723', '923052746422', '923931686599', '929126023852', '933831760677', '936096392668', '936117866411', '936363923026', '936680646698', '947872759685', '951802633484', '957132350705', '957518831560', '957734782020', '957966502020', '961541317843', '963879624041', '964426436180', '967972633959', '968301499415', '969413062254', '970156530737', '982935446751', '984281569836', '984625537202', '991428470003', '999355684375']
# # accounts = ['012046266255', '016101336017', '021191302697', '024517926231', '024838550089', '025625448852', '025648210413', '028002051339', '030263312215', '031043502080', '031573843522', '034307784415', '035784263114', '038144103111', '038270351176', '039233901334', '039929384510', '041081560071', '050877488444', '053392642336', '055182143107', '055266516288', '059272759707', '060465202534', '067555441682', '067804797237', '068183022879', '068315429392', '070717231209', '072038240142', '084383639626', '087127721683', '088258796410', '092606503522', '104624496682', '107393473960', '109577287868', '119753528152', '130203272373', '135381627630', '139100456334', '144544136090', '155305736938', '156327752252', '158347257464', '158684596895', '161395754509', '162310846309', '163918101077', '166556434326', '168131472534', '170178091998', '170302206609', '172383415443', '173316567229', '173479391558', '174188575348', '175742142056', '181395753476', '185075825010', '186574298919', '194751376404', '198162557634', '201547482655', '204193633058', '205394135495', '208073657936', '208626548723', '211070001969', '212149607166', '212773838067', '217413253555', '218167183912', '222762603060', '228052005984', '232698387549', '233632481017', '234019974018', '234848667271', '239459044292', '240344030626', '241671150056', '241693290537', '241696072805', '251058218532', '254471163821', '257915333181', '258860010574', '262259241401', '266527211573', '268527685757', '277946231630', '281981188021', '282181226940', '282623329273', '284383242428', '290092688251', '294297099413', '298370672248', '309245159336', '312249472578', '318724812262', '318902570495', '320947721229', '327370950832', '328754255717', '332205887294', '336222303362', '336827305173', '340860049954', '345414987291', '354362986338', '363191287345', '366987310429', '367544918569', '372988589375', '373124920883', '374125395891', '376587057974', '385159429807', '389613005727', '392047261520', '395672011172', '398358669351', '403327078303', '404335588036', '410871088857', '414878987508', '415076259107', '415096990548', '416380726237', '417276993801', '422660281210', '422716773809', '426325367657', '426909158075', '431768475246', '433112528293', '434820176994', '436950664991', '441977708642', '442279558925', '445544608757', '447099417955', '447333052098', '454243075918', '454878478860', '455295949501', '456012650670', '457633433589', '458712402796', '459741916297', '460579496107', '463748631505', '470892628663', '471764684541', '475312077285', '475679390152', '475704409833', '480207372766', '486318442788', '487825727312', '488502120284', '490723148876', '492809362056', '494419598111', '498306521888', '504206122956', '511898103173', '512593562953', '514641961978', '522610480753', '526851179788', '531885649505', '534939542028', '536825901754', '537669063398', '538115423334', '541061827746', '542083475947', '542734845675', '544536937525', '545240029200', '545994597414', '547578050363', '551757942034', '564649271459', '568396353920', '571208668853', '572027877266', '573859772831', '581130070053', '581328788659', '583106373569', '586329412044', '588607312191', '589327882798', '593780602920', '594796041417', '598578472115', '598783347326', '608959785178', '609608201737', '615475426900', '615864598532', '617366402669', '618143286284', '621848218806', '622372203913', '623940634196', '624925071076', '626553292796', '628943449194', '632954654882', '637376217363', '637928158385', '639369182738', '640259690623', '644969574939', '646717608788', '650644976608', '657107451157', '659576002760', '664785693086', '670404736065', '678835796394', '680069428997', '681044841647', '681356837841', '683133891344', '684757896148', '685107354181', '686387901187', '696141481732', '698551361437', '699789982634', '701438804970', '701970095679', '703829513590', '707763339947', '710465056204', '721294810136', '721462236188', '726012408397', '727600915853', '729269827574', '731082648661', '735624102611', '736819047443', '738852525135', '740123642997', '740153750092', '741012202819', '741732532483', '743862158735', '746177754969', '747229060202', '750802954404', '753874989666', '755090050495', '757031139434', '758360774458', '762594668164', '764177646170', '776522867075', '778558837889', '779558345599', '781297070656', '782998046294', '792126690708', '792958435369', '797231615719', '798052893433', '798485367562', '804269864808', '812790839692', '813055922763', '813558814731', '814582850999', '819300110664', '819716157095', '821372114949', '826429160863', '828290435030', '831323883328', '835173813168', '836686594237', '836809512233', '840214933274', '840365407675', '841168632450', '844577878525', '844677627151', '850702558675', '854481054617', '857578946837', '867168973137', '867327676348', '872800060950', '877574383758', '879286378355', '884435246449', '886409264347', '896914459532', '898090075122', '901022633716', '903186577214', '904168909248', '905676609443', '912103569023', '914628935504', '918013418617', '918701091807', '919235719473', '920037858723', '923052746422', '923931686599', '929126023852', '933831760677', '936096392668', '936117866411', '936363923026', '936680646698', '947872759685', '951802633484', '957132350705', '957518831560', '957734782020', '957966502020', '961541317843', '963879624041', '964426436180', '967972633959', '968301499415', '969413062254', '970156530737', '982935446751', '984281569836', '984625537202', '991428470003', '999355684375']

# # for account in total_accounts:
# #     if account not in accounts:
# #         print(account)

# # def assume_to_child_account(account):
    
# #     sts_client = boto3.client('sts')
# #     child_account_assume_role = "DCSLayer0/DCSTempRole"
# #     role_arn = f'arn:aws:iam::{account}:role/{child_account_assume_role}'
# #     print(f'Assuming role: {role_arn}; Account: {account}')
# #     assumed_role = sts_client.assume_role(
# #         RoleArn=role_arn,
# #         RoleSessionName=f'create_roles_new_account{datetime.now().strftime("%Y%m%d%H%M%S%f")}'
# #     )

# #     return assumed_role['Credentials']

# # c = 0
# # for account in accounts:
# #     c=c+1
# #     try:
# #         print(f"iteation {c} of total {len(accounts)}")
# #         child_cred = assume_to_child_account(account)
# #         iam = boto3.client('iam',
# #                                         region_name="us-east-1",
# #                                         aws_access_key_id=child_cred["AccessKeyId"],
# #                                         aws_secret_access_key=child_cred["SecretAccessKey"],
# #                                         aws_session_token=child_cred["SessionToken"])
# #         response = iam.list_attached_role_policies(RoleName="VPCFlowLogsRole")
# #         print(response)
# #         for policy in response['AttachedPolicies']:
# #             iam.detach_role_policy(RoleName="VPCFlowLogsRole", PolicyArn=policy['PolicyArn'])
# #             print("detached the policy")

# #         response = iam.delete_role(RoleName="VPCFlowLogsRole")
# #         print("Role deleted successfully")
# #         print()
# #         print()
# #         print()

# #     except Exception as e:
# #         print("Exception:::", e, sys.exc_info()[-1].tb_lineno)



import boto3
import time
from datetime import date, datetime
import json
from datetime import datetime
import sys
from botocore.exceptions import ClientError
import logging
import os
import sys
import requests

def assume_to_child_account(account):
    
    sts_client = boto3.client('sts')
    child_account_assume_role = "DCSLayer0/DCSTempRole"
    role_arn = f'arn:aws:iam::{account}:role/{child_account_assume_role}'
    print(f'Assuming role: {role_arn}; Account: {account}')
    assumed_role = sts_client.assume_role(
        RoleArn=role_arn,
        RoleSessionName=f'create_roles_new_account{datetime.now().strftime("%Y%m%d%H%M%S%f")}'
    )

    return assumed_role['Credentials']

roles_to_delete = ["TenableIO", "ITSGovernance", "cloudscript_validate", "TaggingAPIRole","DenyITSLayer1PlatformModification"]

accounts = ['008530717892', '010753539596', '014296065027', '016937230970', '026194564518', '038059618311', '047685407929', '051469546478', '062130537180', '063376279610', '073146838139', '077240679103', '084407457870', '095611350051', '099325924796', '103896790399', '119343329730', '124524166810', '135755270796', '142332166808', '151434629482', '161391293302', '168849861669', '171762472359', '178790212740', '184405994032', '212921778948', '222531082059', '225658821723', '226603863404', '227841379693', '235513223743', '237366858765', '245250269795', '251072340318', '254263703118', '269475816966', '292210083552', '294745394203', '306182918611', '307036839104', '307492883559', '327639925109', '328235541546', '340826808143', '345889295625', '347913913427', '354716619065', '359252437790', '363220349094', '363235117348', '368276533222', '368404118071', '373943505089', '385078759766', '397051564974', '403053226718', '413145654121', '413418342606', '413990510913', '428677740062', '432089771844', '436310111307', '441012919436', '442888752927', '453919366994', '470306404467', '474547691682', '479008266961', '480022745122', '483078657402', '489537064020', '502327753374', '503351113243', '512171866621', '522328802007', '524275599438', '529277024000', '534534201911', '534846924117', '535700223023', '537671715099', '547043556405', '547509476297', '551019182106', '561320747596', '584630848692', '589892584776', '590506744596', '594239924270', '595353211380', '606511248153', '634691564906', '640234854210', '644849997084', '644993791984', '647087774510', '647885244255', '652437243948', '658062093174', '659789841918', '661881507687', '688405658638', '695506696950', '696344538400', '721880670703', '724311065114', '738731325101', '740166810819', '745576527420', '747602229289', '748278030583', '766245584008', '767507899515', '775595962189', '776440666163', '791968533226', '801334471752', '802825831136', '808458935611', '814566149193', '819418488580', '822274905021', '824349500053', '834357290412', '836073812853', '848219600572', '848793886259', '858141963590', '858526972147', '862094248680', '874896561479', '875752141512', '881051476853', '886674288950', '895081226716', '910997097838', '918223892161', '927753750267', '928599649920', '931334696467', '936639518272', '941819694106', '955038580167', '955621810722', '957304465555', '958991296092', '964131740148', '971295728977', '971552591868', '986038433815', '989150551987', '994920118214', '997069924264', '999954735781']

# Iterate over each account and remove the specified roles
c = 50
for account in accounts[50:100]:
    print(f"iterating {c} of {len(accounts)}")
    c+=1
    try:
        child_cred = assume_to_child_account(account)
        iam = boto3.client('iam',
                                        region_name="us-east-1",
                                        aws_access_key_id=child_cred["AccessKeyId"],
                                        aws_secret_access_key=child_cred["SecretAccessKey"],
                                        aws_session_token=child_cred["SessionToken"])
        
        # Iterate over each role and detach all policies before deleting
        for role in roles_to_delete:
            if role == "DenyITSLayer1PlatformModification":
                try:
                    policy_arn = f'arn:aws:iam::{account}:policy/DenyITSLayer1PlatformModification'
                    response = iam.list_entities_for_policy(PolicyArn=policy_arn)
                    paginator = iam.get_paginator('list_entities_for_policy')
                    response_iterator = paginator.paginate(
                        PolicyArn=policy_arn,
                        PaginationConfig={
                            'PageSize': 1000, # number of results per page
                        }
                    )

                    for page in response_iterator:
                        entities = page['PolicyGroups'] + page['PolicyUsers'] + page['PolicyRoles']

                        # Detach the policy from each entity
                        for entity in entities:
                            time.sleep(1)
                            
                            entity_type = list(entity.keys())[0]
                        
                            entity_name = entity[entity_type]

                            if "GroupName" in entity_type:
                                iam.detach_group_policy(GroupName=entity_name, PolicyArn=policy_arn)
                                print("Group detached")
                            elif "UserName" in entity_type:
                                iam.detach_user_policy(UserName=entity_name, PolicyArn=policy_arn)
                                print("username detached")
                            elif "RoleName" in entity_type:
                                iam.detach_role_policy(RoleName=entity_name, PolicyArn=policy_arn)
                                

                        # Delete the policy
                        try:
                            iam.delete_policy(PolicyArn=policy_arn)
                            print(f"Deleted policy")
                        except Exception:
                            response = iam.list_policy_versions(
                                PolicyArn=policy_arn
                            )

                            # Delete each version of the policy
                            for version in response['Versions']:
                                if not version['IsDefaultVersion']:
                                    response = iam.delete_policy_version(
                                        PolicyArn=policy_arn,
                                        VersionId=version['VersionId']
                                    )

                            # Delete the policy itself
                            response = iam.delete_policy(
                                PolicyArn=policy_arn
                            )
                            print("Deleted Policy in Exception")

                except Exception as e:
                    print("=============================>Exception:::", e, sys.exc_info()[-1].tb_lineno)
            try:
                attached_policies = iam.list_attached_role_policies(RoleName=role)['AttachedPolicies']
                for policy in attached_policies:
                    iam.detach_role_policy(RoleName=role, PolicyArn=policy['PolicyArn'])
                    print(f"Detached policy {policy['PolicyName']} from role {role}")
                    
                iam.delete_role(RoleName=role)
                print(f"Deleted role {role} from account {account}")
            except iam.exceptions.NoSuchEntityException:
                print(f"Role {role} not found in account {account}")
    except Exception as e:
        print(f"==============================>Error while processing account {account}: {e}")





